pipeline {
    agent any

    environment {
        GIT_TOKEN = credentials('gitTokenAccess')
    }

    stages {
        stage('Checkout') {
            steps {
                script {
                    // Checkout the repository
                    checkout([$class: 'GitSCM', 
                              branches: [[name: '*/main']],
                              userRemoteConfigs: [[url: 'https://github.com/arifislam007/spring-bot-jenkins-k8s.git']],
                              extensions: [[$class: 'CloneOption', depth: 1]]
                            ])
                }
            }
        }

        stage('Make Changes') {
            steps {
                sh '''
				echo ${BUILD_NUMBER}
				sed -i "s/spring-bot:base/spring-bot:${BUILD_NUMBER}/g" ./deployment.yml
				'''
            }
        }

        stage('Publish Changes to testing') {
            steps {
                script {
                    // Configure Git Publisher
                    def publisher = [$class: 'GitPublisher', 
                                     configVersioning: [[
                                         credentialsId: 'gitTokenAccess', 
                                         repositoryName: 'origin', 
                                         branches: [[name: 'testing']], 
                                         notes: '', 
                                         notesIsHtml: false, 
                                         forcePush: false, 
                                         tagToPush: '', 
                                         targetRepoName: ''
                                     ]]
                                   ]
                    
                    // Publish using Git Publisher
                    gitPublish publishers: [publisher]
                }
            }
        }
    }
}
